server {
<% if defined?(@url) -%>
    listen 80;
    server_name <%= @url %>;
    access_log /var/log/nginx/<%= @url %>.access.log combined;
    error_log /var/log/nginx/<%= @url %>.error.log warn;
<% else -%>
    listen 80 default_server;
    access_log /var/log/nginx/<%= @app['shortname'] %>.access.log combined;
    error_log /var/log/nginx/<%= @app['shortname'] %>.error.log warn;
<% end -%>

    root /srv/www/<%= @app['shortname'] %>/current;

    index index.php;
    
<% if node['wordpress']['wordfence'] == true -%>
    include snippets/wordfence.conf;
<% end -%>

    fastcgi_param PHP_VALUE "upload_max_filesize=<%= node[:wordpress][:max_upload_size]%>
post_max_size=<%= node[:wordpress][:max_upload_size]%>
max_execution_time=<%= node[:wordpress][:max_execution_time]%>";

<% if node['wordpress']['multisite']['enabled'] == true -%>
    include snippets/wordpress-multisite.conf;
<% else -%>
    location / {
        try_files $uri $uri/ /index.php?$args ;
    }
    
    location ~ .php$ {
        # try_files $uri /index.php;
        include fastcgi_params;
        include snippets/fastcgi-php.conf;
        fastcgi_param PATH_TRANSLATED $document_root$fastcgi_script_name;
        fastcgi_pass unix:/run/php/php7.0-fpm.sock;
    }
<% end -%>

    location ~ /\.ht {
        deny all;
    }

    # Directives to send expires headers and turn off 404 error logging.
    location ~* \.(js|css|png|jpg|jpeg|gif|ico)$ {
        expires 24h;
        log_not_found off;
    }

    #avoid php readfile()
    location ^~ /blogs.dir {
        internal;
        alias /srv/www/<%= @app['shortname'] %>/current/wp-content/blogs.dir ;
        access_log off; log_not_found off;      expires max;
    }
}